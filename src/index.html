<html>
<head>
<meta charset=utf-8>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script>
var _dbName = "jupiter";
var map = function(doc) {
	if (doc.DocType != undefined &&
	doc.DocType == "Formular")
		emit(doc._id, doc);
};

$.couch.db(_dbName).query(function(doc) {
	if (doc.DocType != undefined &&
	doc.DocType == "Formular")
		emit(doc._id, doc);
},null, null, {
	success : function(data) {
		LoadSelectionFormulare(data);
	},
	error : function(data) {
		$("body").text("ERROR: "+data);
	}
});

function LoadSelectionFormulare(formulare) {
	$("#divFormulare").empty();
	$("#divFormulare").append("<select>");
	for (var i = 0; i < formulare.total_rows; i++)
	{
		$("#divFormulare select").append("<option value="+formulare.rows[i].value._id+">"+formulare.rows[i].value.Bezeichnung+"</option>");
	}
	$("#divFormulare").append("</select>");
}

function Save() {
	alert($("#textboxFormularBezeichnung").val());
	var doc = {
		"DocType" : "Formular",
		"Bezeichnung" : $("#textboxFormularBezeichnung").val(),
		"Felder" : GetFelder()
	};

	$.couch.db(_dbName).saveDoc(doc, {
	success : function(data) {
		console.log(data);
	},
	error : function(data) {
		console.log(data);
	}
	});

}

function GetFelder() {
	var felder = new Array();

	$("#divFelder [name='feld']").each( function() {
		var feld = {};
		feld.Bezeichnung = $("[name='bezeichnung']", this).val();
		feld.Anzahl = $("[name='anzahl']", this).val();
		feld.IsAnzuzeigen = $("[name='isAnzuzeigen'] :selected", this).val();
		felder.push(feld);
	});

	return felder;
}

function Delete() {
	alert($("#textboxFormularBezeichnung").val());
	var doc = {
		"_id" : $("#textboxId"),
		"_rev" : $("#textboxRev").val()
	};

	$.couch.db(_dbName).removeDoc(doc, {
	success : function(data) {
		console.log(data);
	},
	error : function(data) {
		console.log(data);
	}
	});
}

function AddFeld(bezeichnung, anzahl, isAnzuzeigen) {
	var feld = "";
	feld += "<div name=feld>";
	feld += "Bezeichnung: <input name=bezeichnung type=text value=" + (bezeichnung == undefined ? "" : bezeichnung) + "></input>";
	feld += "Max. Anzahl: <input name=anzahl type=text value=" + (anzahl == undefined ? 1 : anzahl) + " ></input>";
	feld += "Anzuzeigen bei Suchen: <select name=isAnzuzeigen ><option value=true selected="+(isAnzuzeigen == undefined || isAnzuzeigen == false ? false : true)+">Ja</input><option value=false selected="+(isAnzuzeigen == undefined || isAnzuzeigen == false ? false : true)+">Nein</option></select>";
	feld += "</div>";
	$("#divFelder").append(feld);
}

$(document).ready( function() {
	$("#textboxId").prop("disabled", true);
	$("#textboxRev").prop("disabled", true);


	if (IsFormularZuLaden())
		LoadFormular();
	else
		AddFeld();

});

function IsFormularZuLaden() {
	if ($("#textboxId").val() != "")
		return true;

	return false;
}
</script>
</head>
<body>
<div id=divFormulare></div>
<div id=divNewFormular>
	Bezeichnung: <input id=textboxFormularBezeichnung type=text></input></br>
	Id: <input id=textboxId type=text></input></br>
	Rev: <input id=textboxRev type=text></input></br>
	<div id=divFelder>
		
	</div>	
	<input id=buttonAddFeld onclick=javascript:AddFeld() type=button value="Feld hinzufügen"></input></br>
	<input id=buttonSaveFormular onclick=javascript:Save() type=button value=Speichern></input>
	<input id=buttonDeleteFormular onlick=javascript:Delete() type=button value=Löschen></input>
</div>
</body>
</html>

<html>
<head>
<meta charset=utf-8>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script>
var _dbName = "jupiter";
var _felder = null;


$(document).ready( function() {
	$("#suchen").click(LoadElemente);
	LoadFormulare();
	LoadFelder();
});

function LoadFelder() {	
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
			doc.DocType == "Formular")
		{
			for (var i = 0; i < doc.Felder.length; i++)
			{
				emit (doc.Felder[i].Bezeichnung, doc.Felder[i]);
			}
		}
		},null, null, {
		success : function(data) {
			LoadSelectionFelder(data.rows);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadSelectionFelder(felder) {
	$("#feldFilter").empty();
	_felder = new Array();
	
	for (var i = 0; i < felder.length; i++)
	{
		_felder.push(felder[i].value);
		console.log(felder[i].value);
	}
		
	var selectTag = "<input id=buttonCreateSelectionFeld type=button value=Hinzufügen></input>";
	$("#feldFilter").append(selectTag);
	
	$("#buttonCreateSelectionFeld").click(CreateSelectionFeld);
}

function CreateSelectionFeld() {
	var selectTag = "";
	selectTag += "<div name=filter >";
	selectTag += "<select name=selectionFeld>";
	for (var i = 0; i < _felder.length; i++)
	{
		selectTag += "<option>" + _felder[i].Bezeichnung + "</option>";
	}
	selectTag += "</select>";
	selectTag += "<input type=text></input>";	
	selectTag += "</div>";
	$("#feldFilter").append(selectTag);
}

function LoadFormulare() {
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
		doc.DocType == "Formular")
			emit(doc.Bezeichnung, doc);
		},null, null, {
		success : function(data) {
			LoadSelectionFormulare(data);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadSelectionFormulare(formulare) {
	$("#formularFilter").empty();
	
	var selectTag = "";
	for (var i = 0; i < formulare.total_rows; i++)
	{
		selectTag += "<input type=checkbox name=formularSelect value='"+formulare.rows[i].value.Bezeichnung+"'>"+formulare.rows[i].value.Bezeichnung+"</input>";
		console.log("Created checkbox: " + formulare.rows[i].value.Bezeichnung);
	}
	$("#formularFilter").append(selectTag);
}

function ReloadElemente() {
	LoadElemente();
}

function LoadElementeByFeldAndValue()
{
	var keyPairs = new Array();
	
	$("[name=filter]").each(
	function(index, value){
		var keyPair = new Array();
		keyPair.push($("[name=selectionFeld] :selected", this).val());
		keyPair.push($("input", this).val().toLowerCase());
		
		keyPairs.push(keyPair);
		
		console.log(JSON.stringify(keyPairs));
	});	
	
	var startKey = keyPairs[0].slice();
	var endKey = keyPairs[0].slice();
	endKey[1] += "\u9999";
		
	$.couch.db(_dbName).view("GetElements/ByFieldNameAndValue",
	{
		startkey : startKey,
		endkey : endKey,
		success : function(data) {
			$("#ergebnisse").empty();
			
			console.log("Ergebnisse: " + data.rows.length);
			
			if (data.rows.length >= 1)
				LoadTabellen(data.rows);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadElemente() {
	LoadElementeByFeldAndValue();
	/*
	var selectedFormulare = new Array();
	
	$("#formularFilter input:checked").each( function(index)	{
		selectedFormulare.push($(this).val());
		console.log("Checked checkbox: " + $(this).val());
	});
	
	var selectedFelder = new Array();
	$("#feldFilter select[name='selectionFeld']").each( function(index)	{
		selectedFelder.push($(this).val());
		console.log("Selected dropdown: " + $(this).val());
	});	
		
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
		doc.DocType == "Data")
			emit(doc.Formular, doc);
		},null, null, {
		keys : JSON.stringify(selectedFormulare),
		success : function(data) {
			$("#ergebnisse").empty();
			
			console.log("Ergebnisse: " + data.total_rows);
			
			if (data.total_rows >= 1)
				LoadTabellen(data.rows);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});*/
}

function LoadTabellen(elemente) {
	var currentFormular = elemente[0].value.Formular;
	
	console.log(currentFormular);
	
	var gruppierteElemente = new Array();
	gruppierteElemente.push(new Array());
	
	for (var i = 0; i < elemente.length; i++)
	{
		if (elemente[i].value.Formular != currentFormular)
		{
			currentFormular = elemente[i].value.Formular;
			
			console.log(currentFormular);
			
			gruppierteElemente.push(new Array());
		}
		
		gruppierteElemente[gruppierteElemente.length - 1].push(elemente[i].value);
	}
		
	console.log("Gruppen: " + gruppierteElemente.length);
	
	for (var i = 0; i < gruppierteElemente.length; i++)
	{
		LoadTabelle(gruppierteElemente[i]);
	}
}

function LoadTabelle(elemente) {
	if (elemente.length == 0)
		return;
		
	var formularBezeichnung = elemente[0].Formular;
	
	console.log("Gesuchtes Formular: " + formularBezeichnung);
		
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
		doc.DocType == "Formular")
			emit(doc.Bezeichnung, doc);
		},null, null, {
		key : formularBezeichnung,
		success : function(data) {	
						
			console.log("Gefundene Formulare: " + data.total_rows);
			
			if (data.total_rows > 0)
				LoadTabelleElemente(data.rows[0].value, elemente);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadTabelleElemente(formular, elemente)
{	
	var html = "<h2>" + formular.Bezeichnung + "</h2>";
	html += "<table>";
	html += LoadTableHeader(formular);
	
	for (var i = 0; i < elemente.length; i++)
	{
		html += LoadTableBodyRow(i + 1, formular, elemente[i]);
	}
	
	html += "</table>";
	$("#ergebnisse").append(html);
}

function LoadTableBodyRow(ergebnisNr, formular, element)
{
	var htmlBodyRow = "<tr>";
	htmlBodyRow += "<td class=ergebnisNummer>" + (ergebnisNr) + "</td>";	
	
	for (var i = 0; i < formular.Felder.length; i++)
	{
		if (formular.Felder[i].IsAnzuzeigen == "true")
		{
			htmlBodyRow += "<td class=formularFeld>";
			
			if (element.Felder[formular.Felder[i].Bezeichnung] != undefined)
			{			
				if (formular.Felder[i].IsListe == "true")
				{
					htmlBodyRow += "<ul>";
					
					for (var j = 0; j < element.Felder[formular.Felder[i].Bezeichnung].length; j++)
					{
						htmlBodyRow += "<li>" + element.Felder[formular.Felder[i].Bezeichnung][j] + "</li>";
					}
					
					htmlBodyRow += "</ul>";
				}
				else
				{
					htmlBodyRow += element.Felder[formular.Felder[i].Bezeichnung];
				}
			}
			
			htmlBodyRow += "</td>";
		}
	}
	
	htmlBodyRow += "<td>" + GetEditButton(element) + "</td>";
	htmlBodyRow += "<td>" + GetDeleteButton(element) + "</td>";
	htmlBodyRow += "</tr>";
	
	return htmlBodyRow;
}

function LoadTableHeader(formular)
{
	var htmlHeader = "<tr>";
	htmlHeader += "<th>#</th>";
	
	for (var i = 0; i < formular.Felder.length; i++)
	{
		if (formular.Felder[i].IsAnzuzeigen == "true")
			htmlHeader += "<th>" + formular.Felder[i].Bezeichnung + "</th>";
	}
	
	htmlHeader += "<th>Bearbeiten</th>";
	htmlHeader += "<th>Löschen</th>";
	htmlHeader += "</tr>";
	
	return htmlHeader;
}

function GetFormular(element)
{
	return element.Formular;
}

function GetDeleteButton(element) {
	var htmlDeleteButton = "";
	htmlDeleteButton += "<input type=button onclick='javascript:Delete(\""+element._id+"\", \""+element._rev+"\")' value=Löschen></input>";
	
	return htmlDeleteButton;
}

function Delete(elementId, elementRev) {
	
	var doc = {
		"_id" : elementId,
		"_rev" : elementRev
	};

	$.couch.db(_dbName).removeDoc(doc, {
	key : elementId,
	success : function(data) {
		alert("Das Element wurde gelöscht!");
		ReloadElemente();
	},
	error : function(data) {
		alert("Fehler: " + data);
	}}
	);
}

function GetEditButton(element) {
	var htmlEditButton = "";
	htmlEditButton += "<a href='http://localhost:5984/jupiter/app/Element.html?id=" + element._id + "&revision=" + element._rev + "'>Bearbeiten</a>";
	
	return htmlEditButton;
}
</script>
<style>
td {
	vertical-align: top;
	border-bottom: 1px dashed black;
}
	
.feldName {
	font-weight: bold;
}

.feldWert {
}
</style>
</head>
<body>
<div id=formularFilter></div>
<div id=feldFilter></div>
<br/><br/>
<input type=button id=suchen value="Suchen"></input>
<div id=ergebnisse></div>
</body>
</html>

<html>
<head>
<meta charset=utf-8>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script>
var _dbName = "jupiter";


$(document).ready( function() {
	LoadElemente();
});

function ReloadElemente() {
	LoadElemente();
}

function LoadElemente() {	
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
		doc.DocType == "Data")
			emit(doc.Formular, doc);
		},null, null, {
		success : function(data) {
			$("#ergebnisse").empty();
			
			console.log("Ergebnisse: " + data.total_rows);
			
			if (data.total_rows >= 1)
				LoadTabellen(data.rows);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadTabellen(elemente) {
	var currentFormular = elemente[0].value.Formular;
	
	console.log(currentFormular);
	
	var gruppierteElemente = new Array();
	gruppierteElemente.push(new Array());
	
	for (var i = 0; i < elemente.length; i++)
	{
		if (elemente[i].value.Formular != currentFormular)
		{
			currentFormular = elemente[i].value.Formular;
			
			console.log(currentFormular);
			
			gruppierteElemente.push(new Array());
		}
		
		gruppierteElemente[gruppierteElemente.length - 1].push(elemente[i].value);
	}
		
	console.log("Gruppen: " + gruppierteElemente.length);
	
	for (var i = 0; i < gruppierteElemente.length; i++)
	{
		LoadTabelle(gruppierteElemente[i]);
	}
}

function LoadTabelle(elemente) {
	if (elemente.length == 0)
		return;
		
	var formularBezeichnung = elemente[0].Formular;
	
	console.log("Gesuchtes Formular: " + formularBezeichnung);
		
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
		doc.DocType == "Formular")
			emit(doc.Bezeichnung, doc);
		},null, null, {
		key : formularBezeichnung,
		success : function(data) {	
						
			console.log("Gefundene Formulare: " + data.total_rows);
			
			if (data.total_rows > 0)
				LoadTabelleElemente(data.rows[0].value, elemente);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadTabelleElemente(formular, elemente)
{	
	var html = "<h2>" + formular.Bezeichnung + "</h2>";
	html += "<table>";
	html += LoadTableHeader(formular);
	
	for (var i = 0; i < elemente.length; i++)
	{
		html += LoadTableBodyRow(i + 1, formular, elemente[i]);
	}
	
	html += "</table>";
	$("#ergebnisse").append(html);
}

function LoadTableBodyRow(ergebnisNr, formular, element)
{
	var htmlBodyRow = "<tr>";
	htmlBodyRow += "<td class=ergebnisNummer>" + (ergebnisNr) + "</td>";	
	
	for (var i = 0; i < formular.Felder.length; i++)
	{
		if (formular.Felder[i].IsAnzuzeigen == "true")
		{
			htmlBodyRow += "<td class=formularFeld>";
			
			if (element.Felder[formular.Felder[i].Bezeichnung] != undefined)
			{			
				if (formular.Felder[i].IsListe == "true")
				{
					htmlBodyRow += "<ul>";
					
					for (var j = 0; j < element.Felder[formular.Felder[i].Bezeichnung].length; j++)
					{
						htmlBodyRow += "<li>" + element.Felder[formular.Felder[i].Bezeichnung][j] + "</li>";
					}
					
					htmlBodyRow += "</ul>";
				}
				else
				{
					htmlBodyRow += element.Felder[formular.Felder[i].Bezeichnung];
				}
			}
			
			htmlBodyRow += "</td>";
		}
	}
	
	htmlBodyRow += "<td>" + GetEditButton(element) + "</td>";
	htmlBodyRow += "<td>" + GetDeleteButton(element) + "</td>";
	htmlBodyRow += "</tr>";
	
	return htmlBodyRow;
}

function LoadTableHeader(formular)
{
	var htmlHeader = "<tr>";
	htmlHeader += "<th>#</th>";
	
	for (var i = 0; i < formular.Felder.length; i++)
	{
		if (formular.Felder[i].IsAnzuzeigen == "true")
			htmlHeader += "<th>" + formular.Felder[i].Bezeichnung + "</th>";
	}
	
	htmlHeader += "<th>Bearbeiten</th>";
	htmlHeader += "<th>Löschen</th>";
	htmlHeader += "</tr>";
	
	return htmlHeader;
}

function GetFormular(element)
{
	return element.Formular;
}

function GetDeleteButton(element) {
	var htmlDeleteButton = "";
	htmlDeleteButton += "<input type=button onclick='javascript:Delete(\""+element._id+"\", \""+element._rev+"\")' value=Löschen></input>";
	
	return htmlDeleteButton;
}

function Delete(elementId, elementRev) {
	
	var doc = {
		"_id" : elementId,
		"_rev" : elementRev
	};

	$.couch.db(_dbName).removeDoc(doc, {
	key : elementId,
	success : function(data) {
		alert("Das Element wurde gelöscht!");
		ReloadElemente();
	},
	error : function(data) {
		alert("Fehler: " + data);
	}}
	);
}

function GetEditButton(element) {
	var htmlEditButton = "";
	htmlEditButton += "<a href='http://localhost:5984/jupiter/app/Element.html?id=" + element._id + "&revision=" + element._rev + "'>Bearbeiten</a>";
	
	return htmlEditButton;
}
</script>
<style>
td {
	vertical-align: top;
	border-bottom: 1px dashed black;
}
	
.feldName {
	font-weight: bold;
}

.feldWert {
}
</style>
</head>
<body>
<div id=ergebnisse></div>
</body>
</html>

<html>
<head>
<meta charset=utf-8>
<script src="/_utils/script/jquery.js"></script>
<script src="/_utils/script/jquery.couch.js"></script>
<script>
var _dbName = "jupiter";


$(document).ready( function() {
	$("#textboxId").prop("disabled", true);
	$("#textboxRev").prop("disabled", true);
	
	LoadFormulare();

	if (IsFormularZuLaden())
		Load();
	else
		AddFeld();

});

function Clear() {
	$("#textboxFormularBezeichnung").val("");	
	$("#textboxId").val("");
	$("#textboxRev").val("");
	$("#divFelder").empty();
}

function ReloadFormulare() {
	LoadFormulare();
}

function LoadFormulare() {
	$.couch.db(_dbName).query(function(doc) {
		if (doc.DocType != undefined &&
		doc.DocType == "Formular")
			emit(doc.Bezeichnung, doc);
		},null, null, {
		success : function(data) {
			LoadSelectionFormulare(data);
		},
		error : function(data) {
			$("body").text("ERROR: "+data);
		}
	});
}

function LoadSelectionFormulare(formulare) {
	$("#divFormulare").empty();
	
	var selectTag = "<select id=dropdownFormulare>";
	for (var i = 0; i < formulare.total_rows; i++)
	{
		selectTag += "<option value="+formulare.rows[i].value._id+" rev="+formulare.rows[i].value._rev+">"+formulare.rows[i].value.Bezeichnung+"</option>";
	}
	selectTag += "</select>";
	$("#divFormulare").append(selectTag);

	RegisterSelectionFormulare_Change();
	RegisterSelectionFormulare_Select();	
	Load();
}

function RegisterSelectionFormulare_Change() {

	$("#dropdownFormulare").change( function() {
		/*var formularId = $("#dropdownFormulare :selected").val();
		$("#textboxId").val(formularId);
		
		var formularRev = $("#dropdownFormulare [value="+formularId+"]").attr("rev");
		$("#textboxRev").val(formularRev);*/
		
		Load();
	});
}

function RegisterSelectionFormulare_Select() {
	$("#dropdownFormulare").select( function() {
		/*var formularId = $("#dropdownFormulare :selected").val();
		$("#textboxId").val(formularId);
		
		var formularRev = $("#dropdownFormulare [value="+formularId+"]").attr("rev");
		$("#textboxRev").val(formularRev);*/
		
		Load();
	});
}

function GetJSONFormular() {
	var formular = {
		"DocType" : "Formular",
		"Bezeichnung" : $("#textboxFormularBezeichnung").val(),
		"Felder" : GetFelder()		
	};
	
	if ($("#textboxId").val() != "")
		formular._id = $("#textboxId").val();
	
	if ($("#textboxRev").val() != "")
		formular._rev = $("#textboxRev").val();

	return formular;
}

function GetFelder() {
	var felder = new Array();

	$("#divFelder [name='feld']").each( function() {
		var feld = {};
		feld.Bezeichnung = $("[name='bezeichnung']", this).val();
		feld.IsListe = $("[name='isListe']", this).val();
		feld.IsAnzuzeigen = $("[name='isAnzuzeigen'] :selected", this).val();
		felder.push(feld);
	});

	return felder;
}

function SetJSONFormular(formular) {
	$("#textboxFormularBezeichnung").val(formular.Bezeichnung);	
	$("#textboxId").val(formular._id);
	$("#textboxRev").val(formular._rev);

	$(formular.Felder).each( function() {
		AddFeld(this);
	});
}

function New() {
	$("#divFormulare").empty();
	Clear();
}

function Load() {
	var id = $("#dropdownFormulare").val();
	
	Clear();
	
	$.couch.db(_dbName).query(function(doc) {
		emit(doc._id, doc);
	}, null, null, { 
	key : id,
	success : function(data) {
		if (parseInt(data.total_rows) > 0)
			SetJSONFormular(data.rows[0].value);
	},
	error : function(data) {
		$("body").text("ERROR: "+data);
	}}
	);
}

function Save() {
	$.couch.db(_dbName).saveDoc(GetJSONFormular(), {
	success : function(data) {
		alert("Das Formular wurde gespeichert!");
		ReloadFormulare();
	},
	error : function(data) {
		alert("Fehler: " + data);
	}
	});
}

function Delete() {	
	var id = $("#textboxId").val();
	
	var doc = {
		"_id" : $("#textboxId").val(),
		"_rev" : $("#textboxRev").val()
	};

	$.couch.db(_dbName).removeDoc(doc, {
	key : id,
	success : function(data) {
		alert("Das Formular wurde gelöscht!");
		ReloadFormulare();
	},
	error : function(data) {
		alert("Fehler: " + data);
	}}
	);
}

function AddFeld(feld) {
	var feldHTML = "";
	feldHTML += "<div name=feld>";
	feldHTML += "Bezeichnung: <input name=bezeichnung type=text value=" + (feld.Bezeichnung == undefined ? "" : feld.Bezeichnung) + "></input>";
	feldHTML += "Mehr als 1x: <select name=isListe ><option value=true "+(feld.IsListe == "true" ? "selected" : "")+">Ja</option><option value=false "+((feld.IsListe == "false" || feld.IsListe == undefined) ? "selected" : "")+">Nein</option></select>";
	feldHTML += "Anzuzeigen bei Suchen: <select name=isAnzuzeigen ><option value=true "+ (feld.IsAnzuzeigen == "true" ? "selected" : "")+">Ja</option><option value=false "+ (feld.IsAnzuzeigen == "false" ? "selected" : "")+">Nein</option></select>";
	feldHTML += "</div>";
	$("#divFelder").append(feldHTML);
}

function IsFormularZuLaden() {
	if ($("#textboxId").val() != "")
		return true;

	return false;
}
</script>
</head>
<body>
<div id=divFormulare></div>
<div id=divNewFormular>
	Bezeichnung: <input id=textboxFormularBezeichnung type=text></input></br>
	Id: <input id=textboxId type=text></input></br>
	Rev: <input id=textboxRev type=text></input></br>
	<div id=divFelder>
		
	</div>	
	<input id=buttonAddFeld onclick=javascript:AddFeld() type=button value="Feld hinzufügen"></input></br>
	<input id=buttonNewFormular onclick=javascript:New() type=button value=Neu></input>
	<input id=buttonSaveFormular onclick=javascript:Save() type=button value=Speichern></input>
	<input id=buttonDeleteFormular onclick=javascript:Delete() type=button value=Löschen></input>
</div>
</body>
</html>
